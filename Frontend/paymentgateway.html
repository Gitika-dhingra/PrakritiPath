<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medicine Payment - PrakritiPath</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Color Palette */
            --light-rose-gold: #F3E5F5;
            --medium-rose-gold: #D9A7C7;
            --dark-rose-gold: #B76E79;
            --standard-gold: #D4AF37;
            --light-gold: #E8C15E;
            --soft-peach: #FFF7ED;
            --light-cool-gray: #f3f4f6;
            --light-gray: #e5e7eb;
            --medium-gray: #d1d5db;
            --dark-slate: #1f2937;
            --light-slate: #475569;
        }

        body {
            background: linear-gradient(-45deg, var(--light-gray), var(--medium-gray));
            background-size: 600% 600%;
            animation: liveGradient 25s ease infinite;
            font-family: 'Inter', sans-serif; 
            margin: 0;
            padding: 0;
            color: var(--dark-slate);
        }

        @keyframes liveGradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        header {
            background: var(--light-slate);
            color: var(--light-rose-gold);
            padding: 15px 40px;
            text-align: center;
            font-size: 22px;
            font-weight: bold;
            letter-spacing: 1px;
            border-bottom: 6px solid var(--standard-gold);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Cinzel Decorative', serif;
        }
        
        .back-btn {
            position: absolute;
            left: 20px;
            background: var(--standard-gold);
            color: var(--dark-slate);
            padding: 6px 14px;
            border-radius: 20px;
            text-decoration: none;
            font-weight: bold;
            transition: 0.3s;
            font-size: 14px;
        }
        .back-btn:hover {
            background: var(--light-gold);
        }

        .container {
            max-width: 900px;
            margin: 40px auto;
            background: var(--soft-peach);
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0px 8px 20px rgba(0,0,0,0.1);
            border: 3px solid var(--medium-rose-gold);
        }

        h2 {
            color: var(--dark-rose-gold);
            margin-bottom: 20px;
            border-bottom: 2px solid var(--medium-rose-gold);
            padding-bottom: 5px;
            font-family: 'Cinzel Decorative', serif;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 25px;
        }

        table th, table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--light-rose-gold);
            font-size: 15px;
        }

        table th {
            background: var(--light-rose-gold);
            color: var(--dark-slate);
        }
        
        .quantity-input {
            width: 60px;
            padding: 4px;
            text-align: center;
            border: 1px solid var(--medium-rose-gold);
            border-radius: 5px;
        }

        .total {
            text-align: right;
            font-size: 18px;
            font-weight: bold;
            margin-top: 10px;
            color: var(--dark-rose-gold);
        }

        .payment-options, .address-form {
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid var(--medium-rose-gold);
        }

        label {
            display: block;
            margin: 10px 0 5px;
            font-weight: 600;
            color: var(--dark-slate);
        }

        input, select, textarea {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--medium-rose-gold);
            margin-bottom: 15px;
            font-size: 15px;
            background: var(--soft-peach);
            color: var(--dark-slate);
            box-sizing: border-box; /* Ensures padding doesn't affect width */
        }

        button.primary-btn {
            width: 100%;
            background: var(--dark-rose-gold);
            color: white;
            padding: 14px;
            font-size: 16px;
            border-radius: 10px;
            font-weight: bold;
            border: none;
            cursor: pointer;
            transition: 0.3s;
        }
        button.primary-btn:hover {
            background: var(--standard-gold);
            color: var(--dark-slate);
        }
    </style>
</head>
<body>

    <header>
        <a href="userdashboard.html" class="back-btn">← Back</a>
        Medicine Payment
    </header>

    <div class="container">
        <div class="order-section">
            <h2>Select Medicines</h2>
            <table>
                <thead>
                    <tr>
                        <th>Medicine</th>
                        <th>Price (₹)</th>
                        <th>Quantity</th>
                    </tr>
                </thead>
                <tbody id="medicineList">
                    <tr><td colspan="3">Loading medicines...</td></tr>
                </tbody>
            </table>
            <div class="total">Total Amount: ₹<span id="totalAmount">0</span></div>
        </div>

        <div class="address-form">
            <h2>Delivery Address</h2>
            <form id="addressForm">
                <label for="fullName">Full Name</label>
                <input type="text" id="fullName" placeholder="Enter your full name" required>
                
                <label for="address">Address</label>
                <textarea id="address" rows="3" placeholder="Enter your full address" required></textarea>
                
                <label for="pincode">Pincode</label>
                <input type="text" id="pincode" placeholder="Enter pincode" required>
            </form>
        </div>

        <div class="payment-options">
            <h2>Payment Details</h2>
            <button id="payButton" class="primary-btn">Pay ₹0</button>
        </div>
    </div>

<script>
    const API_BASE_URL = "https://bac-1ntv.onrender.com";

    document.addEventListener('DOMContentLoaded', () => {
        // 1. Check for authentication
        const token = localStorage.getItem("authToken");
        if (!token) {
            alert("You must be logged in to order medicine.");
            window.location.href = "userlogin.html";
            return;
        }

        // 2. Load the list of available medicines from the backend
        loadMedicines(token);

        // 3. Add event listener to the pay button
        document.getElementById("payButton").addEventListener("click", placeOrder);
    });

    async function loadMedicines(token) {
        const medicineList = document.getElementById('medicineList');
        try {
            const response = await fetch(`${API_BASE_URL}/medicines`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (!response.ok) throw new Error("Failed to fetch medicines");

            const medicines = await response.json();
            medicineList.innerHTML = ''; // Clear loading message

            medicines.forEach(med => {
                const row = document.createElement('tr');
                row.dataset.price = med.price;
                row.dataset.id = med.id;
                row.dataset.name = med.name;
                row.innerHTML = `
                    <td>${med.name}</td>
                    <td>₹${med.price}</td>
                    <td><input type="number" value="0" min="0" class="quantity-input" onchange="updateTotal()"></td>
                `;
                medicineList.appendChild(row);
            });
        } catch (error) {
            console.error(error);
            medicineList.innerHTML = `<tr><td colspan="3" style="color:red;">Could not load medicines.</td></tr>`;
        }
    }

    function updateTotal() {
        let total = 0;
        const items = document.getElementById('medicineList').querySelectorAll('tr');
        items.forEach(item => {
            const price = parseFloat(item.dataset.price);
            const quantity = parseInt(item.querySelector('.quantity-input').value, 10);
            if (quantity > 0) {
                total += price * quantity;
            }
        });
        document.getElementById('totalAmount').textContent = total;
        document.getElementById('payButton').textContent = `Pay ₹${total}`;
    }

    async function placeOrder() {
        const token = localStorage.getItem("authToken");
        const user = JSON.parse(localStorage.getItem("loggedInUser"));

        // Collect order items
        const orderItems = [];
        document.getElementById('medicineList').querySelectorAll('tr').forEach(item => {
            const quantity = parseInt(item.querySelector('.quantity-input').value, 10);
            if (quantity > 0) {
                orderItems.push({
                    medicineId: item.dataset.id,
                    name: item.dataset.name,
                    quantity: quantity,
                    price: item.dataset.price
                });
            }
        });

        if (orderItems.length === 0) {
            alert("Please select a quantity for at least one medicine.");
            return;
        }

        // Collect address details
        const address = {
            fullName: document.getElementById('fullName').value,
            address: document.getElementById('address').value,
            pincode: document.getElementById('pincode').value,
        };
        if (!address.fullName || !address.address || !address.pincode) {
            alert("Please fill out all address details.");
            return;
        }
        
        const totalAmount = document.getElementById('totalAmount').textContent;

        try {
            const response = await fetch(`${API_BASE_URL}/order`, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    userId: user.id,
                    items: orderItems,
                    deliveryAddress: address,
                    total: totalAmount
                })
            });

            if (!response.ok) throw new Error("Order placement failed");
            
            const result = await response.json();
            alert(result.message);
            window.location.href = "userdashboard.html";

        } catch (error) {
            console.error(error);
            alert("There was an error placing your order. Please try again.");
        }
    }

    // Assign updateTotal to window so inline onchange can access it
    window.updateTotal = updateTotal;
</script>

</body>
</html>